<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Captain Seawall ‚Äî Cinematic Explosion Edition</title>
  <style>
    :root { --bg:#0a2458; --ground:#2f4a20; --boom:#ffd166; --ui:#f1f5f9; --muted:#94a3b8; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: linear-gradient(#0a2458, #081a3e); color: var(--ui); min-height: 100dvh; display:grid; grid-template-rows:auto 1fr auto; overflow:hidden; }
    header { padding: 14px 18px; display:flex; gap:16px; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,.08); }
    header h1 { margin:0; font-size: clamp(16px, 2.4vw, 22px); letter-spacing:.3px; }
    #hud { display:flex; gap:8px; flex-wrap:wrap; }
    button { appearance:none; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.08); color:var(--ui); padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition: transform .05s ease, background .2s; }
    button:hover{ background:rgba(255,255,255,.14); }
    button:active{ transform: translateY(1px) scale(.98); }

    #scene { position:relative; overflow:hidden; height:65vh; min-height:420px; background: radial-gradient(120% 120% at 50% -10%, #1d4ed8 0%, #0a2458 55%, #081a3e 100%); border-radius: 18px; margin: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35) inset; }
    #scene.shake { animation: shake-subtle 420ms ease-out; }
    @keyframes shake-subtle {
      0% { transform: translate(0,0) }
      20% { transform: translate(6px,-5px) }
      40% { transform: translate(-8px,4px) }
      60% { transform: translate(5px,3px) }
      80% { transform: translate(-4px,-3px) }
      100% { transform: translate(0,0) }
    }

    /* Flash overlay */
    .flash { position:absolute; inset:0; background: radial-gradient(circle at var(--x,50%) var(--y,60%), rgba(255,255,255,.6), rgba(255,244,214,.25) 30%, transparent 60%); pointer-events:none; opacity:0; transition: opacity 120ms ease-out; z-index:8; }
    .flash.show { opacity:1; }
    .flash.fade { transition: opacity 380ms ease-in; opacity:0; }

    /* Terrain */
    .terrain { position:absolute; inset:auto 0 0 0; height:44%; background: linear-gradient(180deg, var(--ground), #1b2e11 65%); z-index:1; transition: filter 200ms ease; }
    .pond { position:absolute; left:58%; bottom:14%; width: 280px; height: 130px; background: radial-gradient(60% 100% at 50% 35%, #2a9957 0, #1f7c46 45%, #155e34 65%, #0f4a29 90%); border-radius: 50% / 38%; box-shadow: inset 0 8px 22px rgba(0,0,0,.35), 0 8px 22px rgba(0,0,0,.35); z-index:1; transition: filter 200ms ease; }

    /* Tank & Enemy */
    #tank { position:absolute; left: 10%; bottom: 48%; width: 210px; height: 90px; z-index:6; filter: brightness(1.15) drop-shadow(0 6px 18px rgba(0,0,0,.55)) drop-shadow(0 0 8px rgba(255,255,255,.12)); transition: filter 180ms ease; }
    .t-body { position:absolute; bottom:18px; width:190px; height:50px; background: linear-gradient(180deg, #93a0af, #4b5563); border-radius: 12px; }
    .t-turret { position:absolute; left:56px; bottom:44px; width:78px; height:36px; background: linear-gradient(180deg, #cbd5e1, #64748b); border-radius: 10px; }
    .t-barrel { position:absolute; left:124px; bottom:58px; width:110px; height:10px; background: #e5e7eb; border-radius: 6px; }
    .t-track { position:absolute; bottom:0; width:210px; height:28px; background: #0b1020; border-radius: 8px; display:flex; align-items:center; gap:10px; padding:0 8px; }
    .wheel { width:18px; height:18px; background:#374151; border-radius:50%; box-shadow: inset 0 0 0 3px #0b1020; }

    #enemy { position:absolute; right: 14%; bottom: 42%; width: 200px; height: 140px; z-index:2; filter: brightness(1) drop-shadow(0 2px 10px rgba(0,0,0,.45)); transition: filter 180ms ease; }
    .lagoon { position:absolute; left:0; top:40px; width:200px; height:100px; border-radius: 50% / 40%; background: radial-gradient(circle at 50% 40%, #34d399 0 40%, #16a34a 60% 100%); box-shadow: 0 8px 18px rgba(0,0,0,.35); }
    .creature { position:absolute; left:32px; top:0; width:136px; height:104px; background: radial-gradient(circle at 50% 30%, #6ee7b7 0 24%, #22c55e 25% 62%, #16a34a 63% 100%); border-radius: 50% 50% 40% 40% / 45% 45% 55% 55%; box-shadow: 0 8px 18px rgba(0,0,0,.35); }

    /* HUD & victory */
    #health { position:absolute; top:14px; right:14px; width:240px; height:20px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; border:1px solid rgba(255,255,255,.2); z-index:10; }
    #healthFill { width:100%; height:100%; background: linear-gradient(90deg, #22c55e, #84cc16); transition: width .35s ease; }
    #victory { position:absolute; inset: 0; display:grid; place-items:center; background: radial-gradient( circle at 50% 70%, rgba(255,255,255,.08), transparent 60% ); opacity:0; pointer-events:none; transition: opacity .5s ease; z-index:9; }
    #victory.show { opacity:1; }
    #victory h2 { font-size: clamp(28px, 5vw, 64px); margin:0; text-shadow: 0 6px 24px rgba(0,0,0,.55); }

    /* Explosion particles */
    .spark { position:absolute; width:7px; height:7px; border-radius:50%; background:#ffd166; box-shadow: 0 0 10px rgba(255,209,102,.95), 0 0 22px rgba(255,209,102,.6); pointer-events:none; }
    .ring { position:absolute; border:3px solid rgba(255,255,255,.7); border-radius:50%; width:12px; height:12px; pointer-events:none; opacity:.95; transform: translate(-50%,-50%) scale(.5); animation: ringOut 900ms cubic-bezier(.2,.8,.2,1) forwards; }
    @keyframes ringOut { to { opacity:0; transform: translate(-50%,-50%) scale(3.6);} }

    /* Smoke puff */
    .smoke { position:absolute; width:10px; height:10px; border-radius:50%; background: radial-gradient(circle, rgba(255,255,255,.9), rgba(148,163,184,.6)); opacity:.9; pointer-events:none; animation: puff 1200ms ease-out forwards; filter: blur(0.6px); z-index:5; }
    @keyframes puff { 0% { transform: translate(0,0) scale(.8); opacity:.9 } 60% { transform: translate(18px,-30px) scale(1.5); opacity:.6 } 100% { transform: translate(36px,-70px) scale(2.1); opacity:0 } }

    footer { padding: 14px 18px; display:flex; gap:12px; align-items:center; justify-content:space-between; color: var(--muted) }
    .kbd { padding:2px 8px; border:1px solid rgba(255,255,255,.2); border-radius:8px; color:#e2e8f0; }
  </style>
</head>
<body>
  <header>
    <h1>üõ°Ô∏è Captain <strong>Seawall</strong> vs. üí© Ball Pond Scum</h1>
    <div id="hud">
      <button id="armBtn" title="Enable audio & arm cannons">üîä Arm Cannons</button>
      <button id="fireBtn">üî• Fire</button>
      <button id="volleyBtn">üí• Triple Volley</button>
      <button id="musicBtn" aria-pressed="true">ü•Å Drums: On ‚Äî March</button>
      <button id="restartBtn">üîÑ Restart</button>
    </div>
  </header>

  <main id="scene" aria-label="Battle scene" role="img">
    <div class="flash" id="flash"></div>
    <div id="health" aria-hidden="true"><div id="healthFill"></div></div>

    <div id="tank" aria-label="Captain Seawall's Tank">
      <div class="t-body"></div>
      <div class="t-turret"></div>
      <div class="t-barrel" id="barrel"></div>
      <div class="t-track">
        <div class="wheel"></div><div class="wheel"></div><div class="wheel"></div><div class="wheel"></div><div class="wheel"></div>
      </div>
    </div>

    <div id="enemy" aria-label="Ball Pond Scum in a pond">
      <div class="lagoon"></div>
      <div class="creature"></div>
    </div>

    <div class="terrain">
      <div class="pond"></div>
    </div>

    <div id="victory" aria-live="polite" aria-atomic="true">
      <h2>Seawall reigns supreme!</h2>
    </div>
  </main>

  <footer>
    <div>Tip: <span class="kbd">F</span>/<span class="kbd">Space</span>=Fire, <span class="kbd">V</span>=Volley, <span class="kbd">M</span>=Toggle Drums</div>
    <div>No trackers, just fun.</div>
  </footer>

  <script>
    // ---------- Web Audio: drum-only military march + SFX + victory tune ----------
    let audioCtx, masterGain;
    let drumsOn = false, drumTimer = null, nextNoteTime = 0;
    const tempo = 112; const sixteenth = 60/tempo/4; // 16th notes

    function makeGain(value = 1.0){ const g = audioCtx.createGain(); g.gain.value = value; g.connect(masterGain); return g; }
    function env(gainNode, t0, a=0.003, d=0.06, s=0.0, r=0.14, peak=1.0){
      const g = gainNode.gain; g.cancelScheduledValues(t0); g.setValueAtTime(0.0001, t0);
      g.exponentialRampToValueAtTime(peak, t0 + a); g.exponentialRampToValueAtTime(Math.max(0.0001, s), t0 + a + d); g.exponentialRampToValueAtTime(0.0001, t0 + a + d + r);
    }
    // Drum voices
    function kick(t, vol=1.0){ const g = makeGain(1.1*vol); const o = audioCtx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(110, t); o.frequency.exponentialRampToValueAtTime(45, t+0.13); o.connect(g); env(g, t, 0.002, 0.09, 0.0001, 0.16, 1.3); o.start(t); o.stop(t+0.28); }
    function snare(t, vol=1.0){ const g = makeGain(0.6*vol); const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.18, audioCtx.sampleRate); const data = buf.getChannelData(0); for(let i=0;i<data.length;i++){ data[i] = (Math.random()*2-1)*Math.pow(1-i/data.length, 2);} const noise = audioCtx.createBufferSource(); noise.buffer = buf; const hp = audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1800; noise.connect(hp); hp.connect(g); env(g, t, 0.001, 0.06, 0.0001, 0.14, 1.0); noise.start(t); noise.stop(t+0.18); }
    function hat(t, vol=1.0){ const g = makeGain(0.2*vol); const o = audioCtx.createOscillator(); o.type='square'; o.frequency.setValueAtTime(8000, t); const hp = audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=5000; o.connect(hp); hp.connect(g); env(g, t, 0.001, 0.02, 0.0001, 0.05, 1.0); o.start(t); o.stop(t+0.06); }
    function flamSnare(t){ snare(t,1.0); snare(t+sixteenth*0.15,0.65); } // double hit

    function scheduleDrums(){
      while(nextNoteTime < audioCtx.currentTime + 0.25){
        for(let step=0; step<32; step++){
          const t = nextNoteTime + step*sixteenth;
          if(step%2===1) hat(t, 0.95);
          if(step%8===0) kick(t,1.0);
          if(step%8===16) kick(t,0.95);
          if(step%8===4) snare(t,1.0);
          if(step%16===15) flamSnare(t);
        }
        nextNoteTime += 32*sixteenth;
      }
    }
    function startDrums(){ if(!audioCtx || drumTimer) return; nextNoteTime = audioCtx.currentTime + 0.05; drumTimer = setInterval(scheduleDrums, 50); }
    function stopDrums(){ if(drumTimer){ clearInterval(drumTimer); drumTimer = null; } }

    // Cannon/Explosion SFX ‚Äî cinematic boom
    function sfxCannon(){ const t = audioCtx.currentTime + 0.001; const o = audioCtx.createOscillator(); const g = makeGain(0.55); o.type='square'; o.frequency.setValueAtTime(190, t); o.frequency.exponentialRampToValueAtTime(80, t+0.09); o.connect(g); env(g, t, 0.001, 0.06, 0.0001, 0.14, 1.1); o.start(t); o.stop(t+0.22);
      const nbuf = audioCtx.createBuffer(1, audioCtx.sampleRate*0.35, audioCtx.sampleRate); const d = nbuf.getChannelData(0); for(let i=0;i<d.length;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length, 1.5);} const noise = audioCtx.createBufferSource(); noise.buffer = nbuf; const lp = audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=550; const g2 = makeGain(0.6); noise.connect(lp); lp.connect(g2); env(g2, t+0.02, 0.01, 0.2, 0.0001, 0.38, 1.0); noise.start(t+0.02); noise.stop(t+0.55); }
    function sfxExplosionCinematic(){ const t = audioCtx.currentTime + 0.001;
      // broadband thump
      const boomNoise = audioCtx.createBuffer(1, audioCtx.sampleRate*1.2, audioCtx.sampleRate); const d = boomNoise.getChannelData(0);
      for(let i=0;i<d.length;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length, 1.1); }
      const src = audioCtx.createBufferSource(); src.buffer = boomNoise;
      const bp = audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=100; bp.Q.value=0.8;
      const g = makeGain(1.1); src.connect(bp); bp.connect(g);
      env(g, t, 0.005, 0.35, 0.0001, 0.85, 1.4); src.start(t); src.stop(t+1.2);
      // low rumbles (two oscillators slightly detuned)
      const o1 = audioCtx.createOscillator(); const o2 = audioCtx.createOscillator();
      o1.type='sine'; o2.type='sine'; o1.frequency.setValueAtTime(58, t); o2.frequency.setValueAtTime(44, t);
      const gL = makeGain(0.35); o1.connect(gL); o2.connect(gL); env(gL, t+0.02, 0.02, 0.4, 0.0001, 1.2, 1.0); o1.start(t+0.02); o2.start(t+0.02); o1.stop(t+1.4); o2.stop(t+1.4);
    }

    // Victory tune (cheerful melody on win)
    function noteToFreq(n){ return 440 * Math.pow(2, (n-69)/12); }
    function playTone(midi, dur, t, type='triangle', vol=0.18){ const g = makeGain(vol); const o = audioCtx.createOscillator(); o.type = type; o.frequency.setValueAtTime(noteToFreq(midi), t); o.connect(g); env(g, t, 0.004, 0.05, 0.0001, Math.max(0.1, dur-0.02), 0.9); o.start(t); o.stop(t+dur+0.02); }
    function playVictoryTune(){ stopDrums(); let t = audioCtx.currentTime + 0.05; const len = 60/112/2*0.9; const m = [60,64,67,72, 72,74,76,77, 79,77,76,74, 72,67,64,60]; m.forEach((n,i)=>playTone(n,len,t+i*len)); }

    // ---------- Game logic ----------
    const scene = document.getElementById('scene');
    const fireBtn = document.getElementById('fireBtn');
    const volleyBtn = document.getElementById('volleyBtn');
    const musicBtn = document.getElementById('musicBtn');
    const restartBtn = document.getElementById('restartBtn');
    const armBtn = document.getElementById('armBtn');
    const enemy = document.getElementById('enemy');
    const healthFill = document.getElementById('healthFill');
    const victory = document.getElementById('victory');
    const flash = document.getElementById('flash');
    const tank = document.getElementById('tank');
    const terrain = document.querySelector('.terrain');
    const pond = document.querySelector('.pond');
    const enemyNode = document.getElementById('enemy');

    function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function makeSmoke(x,y){ const s = document.createElement('div'); s.className = 'smoke'; s.style.left = (x-6) + 'px'; s.style.top = (y-6) + 'px'; scene.appendChild(s); setTimeout(()=>s.remove(), 1200); }
    function makeRing(x,y){ const r = document.createElement('div'); r.className='ring'; r.style.left = x+'px'; r.style.top = y+'px'; scene.appendChild(r); setTimeout(()=>r.remove(), 920); }
    function makeExplosion(x,y){
      makeRing(x,y);
      // Sparks
      const sparks = 86;
      for(let i=0;i<sparks;i++){
        const sp = document.createElement('div'); sp.className='spark';
        const ang = Math.random()*Math.PI*2;
        const dist = 60 + Math.random()*110;
        const dx = Math.cos(ang)*dist; const dy = Math.sin(ang)*dist;
        sp.style.left = x+'px'; sp.style.top = y+'px';
        scene.appendChild(sp);
        sp.animate(
          [{ transform:`translate(0,0)`, opacity:1 }, { transform:`translate(${dx}px, ${dy}px)`, opacity:0 }],
          { duration: 900+Math.random()*500, easing:'cubic-bezier(.22,.61,.36,1)' }
        ).onfinish = ()=> sp.remove();
      }
      // Extra smoke puffs
      for (let i=0;i<4;i++) setTimeout(()=>makeSmoke(x, y), i*120);
    }

    // Subtle shake + flash + temporary lighting
    function screenShake(){ scene.classList.add('shake'); setTimeout(()=>scene.classList.remove('shake'), 420); }
    function flashAt(x,y){
      flash.style.setProperty('--x', (x/scene.clientWidth*100)+'%');
      flash.style.setProperty('--y', (y/scene.clientHeight*100)+'%');
      flash.classList.add('show');
      // fade
      setTimeout(()=>{ flash.classList.add('fade'); }, 30);
      setTimeout(()=>{ flash.classList.remove('show','fade'); }, 420);
    }
    function lightPulse(){
      const glow = 'brightness(1.35) drop-shadow(0 0 22px rgba(255,220,140,.55))';
      tank.style.filter += ' drop-shadow(0 0 10px rgba(255,255,255,.2))';
      enemyNode.style.filter += ' drop-shadow(0 0 10px rgba(255,255,255,.2))';
      terrain && (terrain.style.filter = glow);
      pond && (pond.style.filter = glow);
      setTimeout(()=>{
        terrain && (terrain.style.filter = '');
        pond && (pond.style.filter = '');
      }, 280);
      setTimeout(()=>{
        tank.style.filter = 'brightness(1.15) drop-shadow(0 6px 18px rgba(0,0,0,.55)) drop-shadow(0 0 8px rgba(255,255,255,.12))';
        enemyNode.style.filter = 'brightness(1) drop-shadow(0 2px 10px rgba(0,0,0,.45))';
      }, 360);
    }

    function cinematicImpact(x,y){
      makeExplosion(x,y);
      flashAt(x,y);
      screenShake();
      lightPulse();
      if (audioCtx) sfxExplosionCinematic();
    }

    function fireOne(startX, startY, targetEl){
      const b = document.createElement('div'); b.className = 'cannonball';
      b.style.position='absolute'; b.style.width='14px'; b.style.height='14px'; b.style.borderRadius='50%'; b.style.background='#e5e7eb'; b.style.boxShadow='0 0 12px rgba(255,255,255,.7)';
      const tRect = targetEl.getBoundingClientRect(); const sRect = scene.getBoundingClientRect();
      const tx = tRect.left - sRect.left + tRect.width/2 + rand(-30,30); const ty = tRect.top - sRect.top + tRect.height/2 + rand(-10,20);
      const dx = tx - startX, dy = ty - startY; const dist = Math.hypot(dx,dy); const steps = Math.max(30, Math.min(120, Math.floor(dist / 8)));
      b.style.left = startX + 'px'; b.style.top = startY + 'px'; scene.appendChild(b);
      for (let i=0;i<3;i++) setTimeout(()=>makeSmoke(startX, startY), i*90);
      if (audioCtx) sfxCannon();
      let i=0; const id = setInterval(()=>{
        i++; const p = i/steps;
        const x = startX + dx * p; const y = startY + dy * p - 80*Math.sin(Math.PI*p);
        b.style.left = x + 'px'; b.style.top = y + 'px';
        if (i>=steps) {
          clearInterval(id); b.remove();
          cinematicImpact(tx,ty);
          const current = parseFloat(healthFill.style.width||'100') || 100;
          const next = Math.max(0, current - rand(10,16));
          healthFill.style.width = next + '%';
          if (next <= 0) showVictory();
        }
      }, 16);
    }

    function showVictory(){ victory.classList.add('show'); confetti(); if (audioCtx) playVictoryTune(); }

    function fire(){ const barrel = document.getElementById('barrel'); const sRect = scene.getBoundingClientRect(); const r = barrel.getBoundingClientRect(); const startX = r.left - sRect.left + r.width + 2; const startY = r.top - sRect.top + r.height/2; fireOne(startX, startY, enemy); }
    function volley(){ fire(); setTimeout(fire, 140); setTimeout(fire, 280); }

    // Confetti
    const confColors=["#fbbf24","#ef4444","#3b82f6","#22c55e","#e879f9","#a78bfa","#60a5fa"];
    function confetti(){ for(let i=0;i<180;i++){ const c=document.createElement('div'); c.style.position='fixed'; c.style.left=Math.random()*100+'vw'; c.style.top='-10px'; c.style.width=c.style.height=(6+Math.random()*6)+'px'; c.style.background=confColors[Math.floor(Math.random()*confColors.length)]; c.style.opacity='0.95'; c.style.borderRadius='2px'; c.style.pointerEvents='none'; document.body.appendChild(c); const dur=1800+Math.random()*2200; const rot=(Math.random()*720-360)+'deg'; c.animate([{ transform:'translateY(0) rotate(0deg)', opacity:0.95 }, { transform:`translateY(100vh) rotate(${rot})`, opacity:0.2 }], { duration: dur, easing:'linear' }).onfinish=()=>c.remove(); } }

    // Controls
    function toggleDrums(){ if (!audioCtx) return; drumsOn = !drumsOn; musicBtn.setAttribute('aria-pressed', String(drumsOn)); musicBtn.textContent = drumsOn ? 'ü•Å Drums: On ‚Äî March' : 'ü•Å Drums: Off'; if (drumsOn) startDrums(); else stopDrums(); }
    function restart(){ healthFill.style.width = '100%'; victory.classList.remove('show'); stopDrums(); if (audioCtx) { drumsOn=true; musicBtn.textContent='ü•Å Drums: On ‚Äî March'; startDrums(); } }

    function armAudio(){ if (audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); masterGain = audioCtx.createGain(); masterGain.gain.value = 0.85; masterGain.connect(audioCtx.destination); drumsOn = true; musicBtn.setAttribute('aria-pressed','true'); musicBtn.textContent = 'ü•Å Drums: On ‚Äî March'; startDrums(); armBtn.disabled = true; armBtn.textContent = 'üîì Audio Unlocked'; }

    document.addEventListener('DOMContentLoaded', () => {
      fireBtn.addEventListener('click', fire);
      volleyBtn.addEventListener('click', volley);
      musicBtn.addEventListener('click', toggleDrums);
      restartBtn.addEventListener('click', restart);
      armBtn.addEventListener('click', armAudio);
      scene.addEventListener('pointerdown', armAudio, { once:true });

      window.addEventListener('keydown', (e)=>{
        if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
        if (e.code === 'Space' || e.key.toLowerCase()==='f') { e.preventDefault(); fire(); }
        if (e.key.toLowerCase()==='v') { volley(); }
        if (e.key.toLowerCase()==='m') { toggleDrums(); }
      });
    });
  </script>
</body>
</html>
